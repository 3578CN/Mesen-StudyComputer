<Window
    xmlns="https://github.com/avaloniaui"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:vm="using:Mesen.ViewModels"
    xmlns:du="using:Mesen.Debugger.Utilities"
    xmlns:win="using:Mesen.Windows"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    x:Class="Mesen.Windows.DiskManagementWindow"
    Width="420" Height="520"
    CanResize="False"
    Title="磁盘管理"
    DragDrop.AllowDrop="True"
    x:DataType="vm:DiskManagementViewModel">
    <Design.DataContext>
        <vm:DiskManagementViewModel />
    </Design.DataContext>

    <Window.Resources>
        <!-- 将 double 转为 GridLength，便于在 ColumnDefinition 上绑定像素宽度 -->
        <du:GridLengthConverter x:Key="GridLengthConverter" />
    </Window.Resources>

    <Window.DataTemplates>
        <!-- 窗口范围内的行模板：绑定到窗口 DataContext 中的列宽属性，支持 GridSplitter 双向更新 -->
        <DataTemplate DataType="vm:DiskDirectoryNode">
            <StackPanel>
                <Button Command="{Binding SelectCommand}" Background="{Binding IsSelected, Converter={StaticResource BoolToBrushConverter}}" BorderBrush="Transparent" BorderThickness="0" Padding="0" Margin="0" HorizontalAlignment="Stretch" HorizontalContentAlignment="Stretch" VerticalContentAlignment="Center" MinHeight="18">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="{Binding ColumnNameWidth, RelativeSource={RelativeSource AncestorType=win:DiskManagementWindow}, Mode=TwoWay, Converter={StaticResource GridLengthConverter}}" />
                            <!-- 保留较宽的交互区域（6 DIP）以便拖拽，但实际可见线为 1px -->
                            <ColumnDefinition Width="6" />
                            <ColumnDefinition Width="{Binding ColumnSizeWidth, RelativeSource={RelativeSource AncestorType=win:DiskManagementWindow}, Mode=TwoWay, Converter={StaticResource GridLengthConverter}}" />
                            <ColumnDefinition Width="6" />
                            <ColumnDefinition Width="{Binding ColumnModifiedWidth, RelativeSource={RelativeSource AncestorType=win:DiskManagementWindow}, Mode=TwoWay, Converter={StaticResource GridLengthConverter}}" />
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Horizontal" Grid.Column="0" Margin="{Binding Depth, Converter={StaticResource DepthToMarginConverter}}" VerticalAlignment="Center">
                            <TextBlock Text="{Binding Name}" VerticalAlignment="Center" Opacity="0.8" />
                        </StackPanel>
                        <TextBlock Grid.Column="2" Text="{Binding SizeText}" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.8" Margin="0,0,2,0" />
                        <TextBlock Grid.Column="4" Text="{Binding ModifiedText}" VerticalAlignment="Center" HorizontalAlignment="Left" Opacity="0.8" Margin="2,0,0,0" />
                    </Grid>
                    <Button.ContextMenu>
                        <ContextMenu DataContext="{Binding}">
                            <MenuItem Header="另存为" Click="OnMenuSaveAsClick" />
                            <MenuItem Header="重命名" Click="OnMenuRenameClick" />
                            <MenuItem Header="删除" Click="OnMenuDeleteClick" />
                        </ContextMenu>
                    </Button.ContextMenu>
                </Button>
                <ItemsControl ItemsSource="{Binding Children}" Margin="0" HorizontalAlignment="Stretch" />
            </StackPanel>
        </DataTemplate>
    </Window.DataTemplates>

    <!-- 磁盘管理对话框：监听磁盘 I/O 通知自动刷新 -->
    <DockPanel Margin="8">
        <!-- 顶部显示当前加载的磁盘镜像路径（原来顶部的状态信息将被移到列表下方） -->
        <Border DockPanel.Dock="Top" Margin="0 0 0 8">
            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center" HorizontalAlignment="Stretch">
                <TextBlock Text="{Binding DiskImagePath}" VerticalAlignment="Center" HorizontalAlignment="Stretch" TextTrimming="CharacterEllipsis" ToolTip.Tip="{Binding DiskImagePath}" />
            </StackPanel>
        </Border>

        <!-- 将状态条移动到列表下方（先放置以便后面的主内容作为最后一项填充中心区域） -->
        <Border DockPanel.Dock="Bottom" Margin="0 8 0 0">
            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center" HorizontalAlignment="Left">
                <TextBlock Text="{Binding StatusText}" VerticalAlignment="Center" HorizontalAlignment="Left" />
            </StackPanel>
        </Border>

    <Border x:Name="ListBorder" BorderThickness="0 1 0 0" BorderBrush="{StaticResource MesenGrayBorderColor}">
            <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" Padding="0">
                <!-- 标题行放在 ScrollViewer 内部，使其随列表一起滚动并与行模板对齐 -->
                <StackPanel>
                    <!-- 标题放在列表内并使用与行模板相同的列宽绑定，分隔列放置 GridSplitter 以支持拖动调整列宽 -->
                    <Grid Margin="0 2 0 4" Width="{Binding ColumnTotalWidth}" HorizontalAlignment="Left">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="{Binding ColumnNameWidth, RelativeSource={RelativeSource AncestorType=win:DiskManagementWindow}, Mode=TwoWay, Converter={StaticResource GridLengthConverter}}" />
                                <ColumnDefinition Width="6" />
                                <ColumnDefinition Width="{Binding ColumnSizeWidth, RelativeSource={RelativeSource AncestorType=win:DiskManagementWindow}, Mode=TwoWay, Converter={StaticResource GridLengthConverter}}" />
                                <ColumnDefinition Width="6" />
                                <ColumnDefinition Width="{Binding ColumnModifiedWidth, RelativeSource={RelativeSource AncestorType=win:DiskManagementWindow}, Mode=TwoWay, Converter={StaticResource GridLengthConverter}}" />
                        </Grid.ColumnDefinitions>

                        <TextBlock Grid.Column="0" Text="名称" VerticalAlignment="Center" Opacity="0.8" Margin="4,0,0,0" />

                        <!-- 第一条可拖动分隔线：视觉为 1px，交互区为 6 DIP -->
                        <GridSplitter Grid.Column="1" Width="6" HorizontalAlignment="Stretch" Background="Transparent" Cursor="SizeWestEast" ResizeDirection="Columns" ResizeBehavior="PreviousAndNext" />
                        <Rectangle Grid.Column="1" Width="1" HorizontalAlignment="Center" Fill="{StaticResource MesenGrayBorderColor}" IsHitTestVisible="False" />

                        <TextBlock Grid.Column="2" Text="大小" VerticalAlignment="Center" HorizontalAlignment="Right" Opacity="0.8" Margin="0,0,3,0" />

                        <!-- 第二条可拖动分隔线：视觉为 1px，交互区为 6 DIP -->
                        <GridSplitter Grid.Column="3" Width="6" HorizontalAlignment="Stretch" Background="Transparent" Cursor="SizeWestEast" ResizeDirection="Columns" ResizeBehavior="PreviousAndNext" />
                        <Rectangle Grid.Column="3" Width="1" HorizontalAlignment="Center" Fill="{StaticResource MesenGrayBorderColor}" IsHitTestVisible="False" />

                        <TextBlock Grid.Column="4" Text="修改时间" VerticalAlignment="Center" HorizontalAlignment="Left" Opacity="0.8" Margin="3,0,0,0" />
                    </Grid>

                    <!-- 移除对 Viewport.Width 的强制绑定，使 ItemsControl 能根据内容宽度伸展，
                         并将水平对齐改为 Left，以便当内容宽度大于 ScrollViewer 时出现横向滚动条 -->
                    <ItemsControl ItemsSource="{Binding Items}" HorizontalAlignment="Left" Width="{Binding ColumnTotalWidth}" />
                </StackPanel>
            </ScrollViewer>
        </Border>
    </DockPanel>
</Window>